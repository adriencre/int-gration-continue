# CI GitHub Actions - Équivalent du TP GitLab CI
# Stages : validate (lint, only-canary), test (unit-test, integration-test, e2e-test)
# Exo 5 : réutilisation via composite action .github/actions/setup-node-ci

name: CI GitHub Actions

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      env_target:
        description: "Environnement (ex: canary pour lancer only-canary)"
        required: false
        default: ""

env:
  # Exo 3 : comme GitLab, variable ENV_TARGET (Settings > Variables ou workflow_dispatch)
  ENV_TARGET: ${{ vars.ENV_TARGET || inputs.env_target || '' }}

jobs:
  # Stage validate - Lint
  lint:
    name: Lint (validate)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-node-ci
      - name: Lint Validation
        run: npm run lint

  # Stage validate - Only Canary (Exo 3)
  # Déclenché si variable ENV_TARGET=canary (Settings > Variables) ou Run workflow avec env_target=canary
  only-canary:
    name: Only Canary (validate)
    runs-on: ubuntu-latest
    if: vars.ENV_TARGET == 'canary' || (github.event_name == 'workflow_dispatch' && inputs.env_target == 'canary')
    steps:
      - run: echo "Hello Only Canary !"

  # Stage test - Unit tests
  unit-test:
    name: Unit tests (test)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-node-ci
      - name: Run unit tests
        run: npm test

  # Stage test - Integration test (Exo 4, needs unit-test)
  integration-test:
    name: Integration test (test)
    runs-on: ubuntu-latest
    needs: unit-test
    steps:
      - run: echo "Hello Integration !"

  # Stage test - E2E test (Exo 2, uniquement sur Pull Request, needs integration-test)
  e2e-test:
    name: E2E test (test)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    needs: integration-test
    steps:
      - run: echo "Hello E2E !"

  # Stage build - Build HTML et artefact (Exercice build + artefact)
  build:
    name: Build (build)
    runs-on: ubuntu-latest
    needs: integration-test
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup-node-ci
      - name: Build
        run: npm run build
      - name: Upload dist as artifact
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist
